<?xml version="1.0" encoding="utf-8"?>
<project name="protobuf">
	
	<!-- <target name="-set.protoc.path.mac" if="is.mac">
		<property name="protoc" value="/usr/local/bin/protoc"/>
		<available file="${protoc}" property="protoc.present"/>
	</target>

	<target name="-set.protoc.path.linux" if="is.linux">
		<property name="protoc" value="/usr/bin/protoc"/>
		<available file="${protoc}" property="protoc.present"/>
	</target>

	<target name="-protoc.installation.advice" unless="protoc.present">
		<fail message="Install protocol buffers to build this module."/>
	</target> -->
	
	
  <target name="-protobuf available" extensionOf="-pre-setup">
    <local name="protoc"/>
    <exec executable="protoc" failifexecutionfails="no" outputproperty="protoc">
      <arg line="--version"/>
    </exec>
    <fail unless="protoc" message="ProtoBuf not installed"/>
    <echo message="Using ProtoBuf ${protoc}"/>

    <property name="main.proto" location="src/main/protobuf"/>
    <property name="test.proto" location="src/test/proto"/>

    <available property="protobuf.has.main.sources"
	       type="dir" file="${main.proto}"/>
    <available property="protobuf.has.test.sources"
	       type="dir" file="${test.proto}"/>
  </target>

  <macrodef name="protoc">
    <attribute name="source"/>
    <attribute name="target"/>

    <sequential>
      <mkdir dir="@{target}"/>
      <apply executable="protoc" parallel="on" failonerror="yes">
	<arg value="-I@{source}"/>
	<arg value="--java_out=@{target}"/>
	<fileset dir="@{source}">
	  <include name="**/*.proto"/>
	</fileset>
      </apply>
    </sequential>
  </macrodef>
  
  <extension-point name="-pre-proto" depends="-protobuf available"/>
  <extension-point name="-pre-test-proto" depends="-protobuf available"/>

  <target name="proto" extensionOf="-pre-build" depends="-pre-proto"
	  if="protobuf.has.main.sources">
    <protoc source="${main.proto}" target="${target.dir}/main-proto"/>
    <appenddir to="main.sources" dir="${target.dir}/main-proto"/>
  </target>

  <target name="proto-test" extensionOf="-pre-build-test"
	  depends="-pre-test-proto" if="protobuf.has.test.sources">
    <protoc source="${test.proto}" target="${target.dir}/test-proto"/>
    <appenddir to="test.sources" dir="${target.dir}/test-proto"/>
  </target>
</project>
